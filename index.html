<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Image Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styles for the generated image container */
        .image-container {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb; /* Gray-200 */
            transition: all 0.3s ease;
        }
        .loading-spinner {
            border-top-color: #3b82f6; /* Blue-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Global Header -->
    <header class="bg-white shadow-lg rounded-xl mb-6 p-4 max-w-4xl mx-auto">
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-extrabold text-gray-900">
                <span class="text-blue-600">Gemini</span>
                <span class="hidden sm:inline">Image Generator</span>
            </h1>
            <p class="text-sm text-gray-500 hidden md:block">A high-quality visual tool powered by Imagen 4.0</p>
        </div>
    </header>

    <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden p-6 sm:p-10">

        <!-- Main Content Title (now inside the card for better flow) -->
        <div class="text-center mb-10">
            <h2 class="text-3xl font-extrabold text-gray-800">Create Your Image</h2>
            <p class="text-gray-500 mt-1">Describe the scene you want the AI to visualize.</p>
        </div>

        <!-- Style Selector & Prompt Input Form -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            
            <!-- New Select Menu (Style Selector) -->
            <div class="md:col-span-1">
                <label for="styleSelector" class="block text-lg font-medium text-gray-700 mb-2">
                    Select Style
                </label>
                <select 
                    id="styleSelector" 
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    onchange="updatePromptPlaceholder()"
                >
                    <option value="" selected>Default (No Style)</option>
                    <option value=", digital painting, high fantasy artstation">Digital Painting</option>
                    <option value=", photorealistic, 8k professional photograph">Photorealistic</option>
                    <option value=", anime style, cinematic lighting">Anime/Manga Style</option>
                    <option value=", watercolor painting, delicate brushstrokes">Watercolor Painting</option>
                    <option value=", cyberpunk style, neon lights, dark atmosphere">Cyberpunk Art</option>
                    <option value=", vaporwave aesthetic, pastel colors, glitch effect">Vaporwave</option>
                    <option value=", pixel art, 8-bit, retro game style">Pixel Art</option>
                    <option value=", intricate pencil sketch, detailed shading, line art">Pencil Sketch</option>
                    <option value=", 3D render, Octane render, cinematic volumetric light">3D Render</option>
                    <option value=", classic oil painting on canvas, thick impasto">Oil Painting</option>
                </select>
            </div>

            <!-- Existing Prompt Input -->
            <div class="md:col-span-3">
                <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">
                    What image do you want to create?
                </label>
                <textarea
                    id="prompt"
                    rows="3"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                    placeholder="A futuristic city skyline at sunset, highly detailed"
                ></textarea>
            </div>
        </div>

        <!-- Action Button -->
        <div class="flex flex-col sm:flex-row gap-4 mb-10">
            <button
                id="generateButton"
                class="flex-1 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="generateImage()"
            >
                Generate Image
            </button>
            <button
                id="downloadButton"
                class="sm:w-1/3 bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-gray-300 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
                onclick="downloadImage()"
            >
                Download Image
            </button>
        </div>

        <!-- Generated Image Area -->
        <div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Generated Visual:</h2>
            <div id="outputContainer" class="image-container rounded-xl shadow-inner border border-gray-300">
                <p id="initialMessage" class="text-gray-500 p-8 text-center">Your generated image will appear here. The model used is `imagen-4.0-generate-001`.</p>
                <!-- Image or Loading Spinner will be inserted here -->
            </div>
            <p id="errorMessage" class="text-red-600 mt-4 font-medium hidden"></p>
        </div>
    </div>

    <!-- Global Footer -->
    <footer class="max-w-4xl mx-auto mt-6 text-center text-gray-500 text-xs p-4">
        <p>&copy; 2025-2026 AI Image Generator App. All rights reserved.</p>
        <p class="mt-1">Images created using Google's Imagen 4.0 via the Gemini API.</p>
    </footer>

    <!-- JavaScript for API Interaction -->
    <script>
        // Set the model ID for high-quality image generation
        const MODEL_ID = "imagen-4.0-generate-001";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:predict`;
        const apiKey = ""; // Canvas will automatically provide the key if this is empty
        const styleSelector = document.getElementById('styleSelector');

        // DOM elements
        const promptInput = document.getElementById('prompt');
        const generateButton = document.getElementById('generateButton');
        const downloadButton = document.getElementById('downloadButton');
        const outputContainer = document.getElementById('outputContainer');
        const initialMessage = document.getElementById('initialMessage');
        const errorMessage = document.getElementById('errorMessage');

        let generatedImageUrl = null;

        /**
         * Simple helper function to update placeholder based on style selection.
         */
        function updatePromptPlaceholder() {
            const selectedStyle = styleSelector.options[styleSelector.selectedIndex].text;
            let placeholder = "A lone astronaut floating in space, deep blue background, detailed helmet";

            if (selectedStyle === 'Digital Painting') {
                placeholder = "A fierce dragon guarding a treasure chest in a cave, digital painting, dramatic lighting";
            } else if (selectedStyle === 'Photorealistic') {
                placeholder = "Close-up portrait of a Shiba Inu puppy wearing a tiny knitted hat, photorealistic, 8k";
            } else if (selectedStyle === 'Cyberpunk Art') {
                placeholder = "A rainy night in Neo-Tokyo, street vendor selling noodles under neon signs, cyberpunk style";
            }

            promptInput.placeholder = placeholder;
        }

        /**
         * Hides the error message and clears any previous image.
         */
        function resetState() {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
            generatedImageUrl = null;
            downloadButton.disabled = true;

            // Clear previous content but keep the initial message if it exists
            const existingImage = outputContainer.querySelector('img');
            const existingSpinner = outputContainer.querySelector('.loading-spinner');
            if (existingImage) existingImage.remove();
            if (existingSpinner) existingSpinner.remove();

            if (initialMessage.classList.contains('hidden')) {
                initialMessage.classList.remove('hidden');
            }
            outputContainer.style.backgroundColor = '#e5e7eb'; // Reset background color
        }

        /**
         * Displays the loading state (spinner).
         */
        function showLoading() {
            resetState();
            initialMessage.classList.add('hidden');
            generateButton.disabled = true;
            generateButton.textContent = 'Generating... Please wait, this may take a moment.';

            const spinnerHtml = `
                <div class="loading-spinner h-12 w-12 border-4 border-gray-200 rounded-full border-b-transparent"></div>
            `;
            outputContainer.innerHTML = spinnerHtml;
            outputContainer.style.backgroundColor = '#f3f4f6'; // Light gray while loading
        }

        /**
         * Displays an error message.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            console.error(message);
            outputContainer.innerHTML = `<p class="text-red-600 p-8 text-center font-bold">Generation Failed</p><p class="text-gray-600 p-2 text-center">${message}</p>`;
            errorMessage.textContent = 'Failed to generate image. Please check your prompt and try again.';
            errorMessage.classList.remove('hidden');
            generateButton.disabled = false;
            generateButton.textContent = 'Generate Image';
        }

        /**
         * Displays the generated image.
         * @param {string} base64Data - The base64 encoded image data.
         */
        function displayImage(base64Data) {
            generatedImageUrl = `data:image/png;base64,${base64Data}`;
            
            // Remove previous spinner/message
            outputContainer.innerHTML = '';

            const imageHtml = `
                <img
                    id="generatedImage"
                    src="${generatedImageUrl}"
                    alt="AI Generated Image"
                    class="w-full h-full object-contain rounded-xl"
                    onload="this.parentElement.style.backgroundColor = 'transparent';"
                />
            `;
            outputContainer.innerHTML = imageHtml;
            outputContainer.style.backgroundColor = 'transparent'; 

            generateButton.disabled = false;
            generateButton.textContent = 'Generate Image';
            downloadButton.disabled = false;
        }

        /**
         * Fetches with exponential backoff retry mechanism.
         * @param {string} url - The API URL.
         * @param {object} options - Fetch options.
         * @param {number} maxRetries - Maximum number of retries.
         */
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Throw error to trigger retry logic for server errors (5xx) or rate limits (429)
                        if (response.status >= 500 || response.status === 429) {
                            throw new Error(`Server error or rate limit (${response.status})`);
                        }
                        // For client errors (4xx), stop and return the response immediately
                        return response;
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error(`Failed after ${maxRetries} attempts. ${error.message}`);
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Handles the main image generation process.
         */
        async function generateImage() {
            const basePrompt = promptInput.value.trim();
            const selectedStyle = styleSelector.value;
            
            if (!basePrompt) {
                showError("Please enter a descriptive prompt.");
                return;
            }

            // Combine base prompt with style modifier
            const finalPrompt = `${basePrompt}${selectedStyle}`;

            showLoading();
            resetState(); // Reset error/image state

            const payload = {
                instances: [{
                    prompt: finalPrompt
                }],
                parameters: {
                    // Generate one image sample
                    sampleCount: 1, 
                    // Set aspect ratio to landscape (common for high-quality visuals)
                    aspectRatio: "16:9", 
                    // Use a creative seed for variety, if needed, though usually omitted
                }
            };
            
            try {
                const response = await fetchWithRetry(
                    `${API_URL}?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                // Extract the base64 encoded image data
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                if (base64Data) {
                    displayImage(base64Data);
                } else {
                    throw new Error("API response was successful but image data was missing or malformed.");
                }

            } catch (error) {
                showError(error.message || "An unknown error occurred during image generation.");
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Image';
            }
        }

        /**
         * Handles downloading the currently displayed image.
         */
        function downloadImage() {
            if (generatedImageUrl) {
                const link = document.createElement('a');
                link.href = generatedImageUrl;
                
                // Use a dynamic name based on the prompt
                let filename = promptInput.value.substring(0, 30).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                if (filename.length > 0) {
                    filename += '_ai_art.png';
                } else {
                    filename = 'ai_generated_image.png';
                }
                
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', updatePromptPlaceholder);
    </script>
</body>
</html>